/*! septikon 2016-09-03 */
var Septikon=Septikon||{};Septikon.directions={N:1,E:2,S:4,W:8},Septikon.playerPositions={local:1,remote:2},Septikon.tileSize=25,Septikon.tileGap=4.89,Septikon.boardCenterX,Septikon.boardCenterY,Septikon.rollValue=0,Septikon.setupMode=!0,Septikon.preload=function(a){a.load.image("board","assets/medium_board.png"),a.load.image("clone","assets/clone.png")},Septikon.getLegalMoves=function(a,b,c){a--;var d=[];dir={North:1,East:2,South:4,West:8};for(direction in dir){var e=this.getCoordFromDirection(b,direction);if(Septikon.tileCollection[b.x][b.y].isDamaged===!1&&Septikon.checkWall(direction,b)===!0&&("undefined"==typeof c||"undefined"!=typeof c&&JSON.stringify(e)!==JSON.stringify(c)))if(0==a)d.push(e);else{var f=Septikon.getLegalMoves(a,e,b);for(index in f)JSON.stringify(f[index])!==JSON.stringify(b)&&d.push(f[index])}}return d},Septikon.create=function(a){this.group=a.add.group(),this.groupHUDRight=a.add.group(),this.groupPopups=a.add.group(),this.groupDice=a.add.group(),Septikon.board=a.add.sprite(a.world.centerX,a.world.centerY,"board"),Septikon.board.anchor.set(.5),Septikon.boardCenterX=a.world.centerX-75,Septikon.boardCenterY=a.world.centerY,this.player1=new Septikon.Player("Player 1","Red",Septikon.playerPositions.local),this.player2=new Septikon.Player("Player 2","Blue",Septikon.playerPositions.remote),this.group.add(Septikon.board),Septikon.tileStartX=Septikon.board.x-Septikon.board.width/2+52,Septikon.tileStartY=Septikon.board.y-Septikon.board.height/2+51,this.player1.initResources(a,this.player1),this.group.pivot={x:a.world.centerX,y:a.world.centerY},this.group.x=Septikon.boardCenterX,this.group.y=Septikon.boardCenterY,this.groupHUDRight.x=this.groupDice.x=a.world.width,this.groupDice.visible=!1,Septikon.tileCollection=this.createTiles(a),Septikon.player1HUD=new Septikon.HUD(a,"player1-HUD","right",{title:this.player1.name}),this.welcomePopup=new Septikon.popup(a,{x:0,y:0},{title:"Welcome to Septikon!",content:"To begin, place clones on legal tiles. Navigate the board with the arrow keys and num keys on your keyboard. \n{1, 3, and 5 in particular}",buttons:[{title:"Got it!",callback:Septikon.groupPopups.removeAll,context:Septikon.groupPopups}]})},Septikon.update=function(){},Septikon.createTiles=function(a){var b=a.add.graphics(0,0),c=[],d=31,e=21;b.lineStyle(4,16767232,1),b.drawRoundedRect(0,0,Septikon.tileSize+3,Septikon.tileSize+3,2);for(var f=0;f<d;f++)for(var g=0;g<e;g++)currentTile=a.add.sprite(Septikon.tileSize,Septikon.tileSize,b.generateTexture()),currentTile.anchor.set(.5),currentTile.title="tile_"+f+"_"+g,currentTile.x=Septikon.tileStartX+Septikon.tileSize*f+Septikon.tileGap*f,currentTile.y=Septikon.tileStartY+Septikon.tileSize*g+Septikon.tileGap*g,currentTile.alpha=0,currentTile.isDamaged=!1,currentTile.highlightUp=function(b){a.add.tween(b).to({alpha:1},250,Phaser.Easing.Linear.None,!0)},currentTile.highlightDown=function(){a.add.tween(this).to({alpha:0},250,Phaser.Easing.Linear.None,!0)},currentTile.inputEnabled=!0,currentTile.events.onInputUp.add(Septikon.listener,this),f<9&&(currentTile.tileOwner=Septikon.playerPositions.local),f>22&&(currentTile.tileOwner=Septikon.playerPositions.remote),this.group.add(currentTile),"undefined"==typeof c[f]&&(c[f]=[]),c[f][g]=currentTile;return $(function(){$.ajaxSetup({cache:!1}),$.getJSON("js/tiles.json",function(a){for(var b in a)if(a.hasOwnProperty(b)){var d=a[b];for(var e in d)if(d.hasOwnProperty(e))for(var f=d[e].locations.length,g=0;g<f;g++){var h=d[e].locations[g].split(","),i=h[0],j=h[1];c[i][j].xCoord=parseInt(i),c[i][j].yCoord=parseInt(j),c[i][j].tileType=d[e].type,"undefined"!=typeof c[i][j]?c[i][j].tileName=d[e].name:console.log(i+":"+j+" not found!"),"undefined"!=typeof d[e].properties&&(c[i][j].tileResourceCostCount=d[e].properties.resourceCostCount,c[i][j].tileResourceCostType=d[e].properties.resourceCostType)}}})}),b.destroy(),c},Septikon.beginGame=function(){console.log("Let's get it started."),Septikon.setupMode=!1,Septikon.groupPopups.removeAll(Septikon.groupPopups),Septikon.groupDice.visible=!0},Septikon.listener=function(a){for(index in Septikon.player1.movementManager.selectedLegalMoves)if(Septikon.player1.movementManager.selectedLegalMoves[index].x==a.xCoord&&Septikon.player1.movementManager.selectedLegalMoves[index].y==a.yCoord){if(Septikon.player1.movementManager.selectedClone.move(Septikon.player1.movementManager.selectedLegalMoves[index]),"surface"==a.tileType?Septikon.player1.movementManager.selectedClone.isGunner=!0:Septikon.player1.movementManager.selectedClone.isGunner=!1,"armory"==a.tileType)for(index in Septikon.player1.cloneCollection)Septikon.player1.cloneCollection[index].arm.indexOf(a.tileName)==-1&&Septikon.player1.cloneCollection[index].arm.push(a.tileName);for(index in Septikon.player1.movementManager.selectedLegalMoves)Septikon.tileCollection[Septikon.player1.movementManager.selectedLegalMoves[index].x][Septikon.player1.movementManager.selectedLegalMoves[index].y].highlightDown();Septikon.rollValue=0,Septikon.player1HUD.rollText.text="Roll"}Septikon.player1.addClone(a)},Septikon.xCoordsToPixel=function(a){return Septikon.tileStartX+a*(Septikon.tileSize+Septikon.tileGap)},Septikon.yCoordsToPixel=function(a){return Septikon.tileStartY+a*(Septikon.tileSize+Septikon.tileGap)},Septikon.checkWall=function(a,b){var c={North:1,East:2,South:4,West:8};switch(a){case"North":if(0==parseInt(WALL_GRID[b.x][b.y]&c.North))return!0;break;case"South":if(0==parseInt(WALL_GRID[b.x][b.y]&c.South))return!0;break;case"East":if(0==parseInt(WALL_GRID[b.x][b.y]&c.East))return!0;break;case"West":if(0==parseInt(WALL_GRID[b.x][b.y]&c.West))return!0;break;default:return!1}},Septikon.rollDice=function(){roll=Math.floor(6*Math.random())+1,Septikon.rollValue=roll,console.log("=================");for(index in Septikon.player1.cloneCollection)x=Septikon.player1.cloneCollection[index].xCoord,y=Septikon.player1.cloneCollection[index].yCoord;return Septikon.player1HUD.rollText.text=roll,roll},Septikon.getCoordFromDirection=function(a,b){var c={North:{x:0,y:-1},East:{x:1,y:0},South:{x:0,y:1},West:{x:-1,y:0}};return{x:parseInt(a.x)+parseInt(c[b].x),y:parseInt(a.y)+parseInt(c[b].y)}},Septikon.Player=function(a,b,c){this.name=a,this.color=b,this.position=c,this.oxygen=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.rocket=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.metal=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.biomass=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.biodrone=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.uranium=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.energy1=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.energy2=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.rocketCollection=[],this.satelliteCollection=[],this.shieldCollection=[],this.biodroneCollection=[],this.nukeCollection=[],this.ResourceManager={types:{oxygen:{id:1,name:"oxygen",startCoord:{x:5,y:0},endCoord:{x:5,y:9},color:2533344},rocket:{id:2,name:"rocket",startCoord:{x:4,y:0},endCoord:{x:4,y:9},color:14628403},metal:{id:3,name:"metal",startCoord:{x:3,y:0},endCoord:{x:3,y:9},color:16772070},biomass:{id:4,name:"biomass",startCoord:{x:5,y:20},endCoord:{x:5,y:11},color:9811004},biodrone:{id:5,name:"biodrone",startCoord:{x:4,y:20},endCoord:{x:4,y:11},color:11024772},uranium:{id:6,name:"uranium",startCoord:{x:3,y:20},endCoord:{x:3,y:11},color:16014366},energy1:{id:7,name:"energy1",startCoord:{x:2,y:0},endCoord:{x:2,y:9},color:16567808},energy2:{id:8,name:"energy2",startCoord:{x:2,y:20},endCoord:{x:2,y:11},color:16567808}},GetResource:function(a,b){},PutResource:function(a,b){console.log(this.GetResourceCount(a,b));var c=new Septikon.Resource(game,position,{type:a,player:b});b[a].push(c)},GetResourceCount:function(a,b){if("undefined"==typeof b[a])return!1;for(var c=0,d=0;d<b[a].length;d++)0==b[a][d].isDamaged&&c++;return c},CountAvailableResources:function(a,b){var c=0,d=!1;for(var e in b[a])0!=b[a][e]?(1==d&&(c=0),c++):d=!0;return c}},this.cloneCollection=[],this.movementManager={selectedClone:null,selectedLegalMoves:{},getObjectArray:function(){}},this.addClone=function(a){return"warehouse"!=a.tileType&&"space"!=a.tileType&&"surface"!=a.tileType&&a.tileOwner==Septikon.playerPositions.local&&(this.ResourceManager.CountAvailableResources("oxygen",this)==this.cloneCollection.length+1&&(Septikon.confirmInit=new Septikon.popup(game,{x:0,y:0},{title:"Confirm Placement?",content:"You have placed all available clones. Would you like to confirm and begin mining?",buttons:[{title:"Confirm",callback:Septikon.beginGame},{title:"Cancel",callback:Septikon.groupPopups.removeAll,context:Septikon.groupPopups}]})),!(this.ResourceManager.CountAvailableResources("oxygen",this)<=this.cloneCollection.length)&&(clone=new Septikon.Clone(game,"clone",{x:a.xCoord,y:a.yCoord},{texture:""}),clone.xCoord=parseInt(a.xCoord),clone.yCoord=parseInt(a.yCoord),clone.inputEnabled=!0,clone.events.onInputDown.add(clone.clicked,clone),void this.cloneCollection.push(clone)))},this.removeClone=function(a){var b=Septikon.player1.cloneCollection.indexOf(a);Septikon.player1.cloneCollection.splice(b,1),a.destroy()},this.initResources=function(a,b){for(var c in b.ResourceManager.types)if(b.ResourceManager.types[c].startCoord.y<b.ResourceManager.types[c].endCoord.y)for(var d=0;d<5;d++){var e={x:b.ResourceManager.types[c].startCoord.x,y:b.ResourceManager.types[c].startCoord.y+d},f=new Septikon.Resource(a,e,{type:c,player:b});b[c][d]=f}else for(var d=0;d<5;d++){var e={x:b.ResourceManager.types[c].startCoord.x,y:b.ResourceManager.types[c].startCoord.y-d},f=new Septikon.Resource(a,e,{type:c,player:b});b[c][d]=f}}},Septikon.Resource=function(a,b,c){var d=a.add.graphics(25,25);d.lineColor=0,d.lineWidth=2,d.beginFill(c.player.ResourceManager.types[c.type].color),d.drawRoundedRect(0,0,20,20,8),this.xCoord=b.x,this.yCoord=b.y,Phaser.Sprite.call(this,a,Septikon.xCoordsToPixel(this.xCoord),Septikon.yCoordsToPixel(this.yCoord),d.generateTexture()),this.anchor.set(.5),this.angle=Math.floor(21*Math.random())-5,this.type=c.player.ResourceManager.types[c.type],this.isDamaged=!1,Septikon.group.add(this),d.destroy()},Septikon.Resource.prototype=Object.create(Phaser.Sprite.prototype),Septikon.Resource.prototype.constructor=Septikon.Resource,Septikon.Clone=function(a,b,c,d){this.xCoord=c.x,this.yCoord=c.y,this.isGunner=!1,this.arm=[],Phaser.Sprite.call(this,a,Septikon.xCoordsToPixel(this.xCoord),Septikon.yCoordsToPixel(this.yCoord),"clone"),this.anchor={x:.5,y:.65},this.scale.setTo(.25),this.angle=90,Septikon.group.add(this)},Septikon.Clone.prototype=Object.create(Phaser.Sprite.prototype),Septikon.Clone.prototype.constructor=Septikon.Clone,Septikon.Clone.prototype.clicked=function(a){if(Septikon.setupMode===!0)Septikon.player1.removeClone(a);else{if("undefined"==typeof Septikon.rollValue||Septikon.rollValue<1)return!1;if(Septikon.player1.movementManager.selectedClone=a,null!==Septikon.player1.movementManager.selectedLegalMoves)for(index in Septikon.player1.movementManager.selectedLegalMoves)Septikon.tileCollection[Septikon.player1.movementManager.selectedLegalMoves[index].x][Septikon.player1.movementManager.selectedLegalMoves[index].y].highlightDown();var b,c=Septikon.player1.movementManager.selectedLegalMoves=Septikon.getLegalMoves(Septikon.rollValue,{x:a.xCoord,y:a.yCoord});for(i in c)b=Septikon.tileCollection[c[i].x][c[i].y],b.highlightUp(b)}},Septikon.Clone.prototype.move=function(a){this.x=Septikon.tileCollection[a.x][a.y].x,this.y=Septikon.tileCollection[a.x][a.y].y,this.xCoord=a.x,this.yCoord=a.y},Septikon.HUD=function(a,b,c,d){var e=a.add.graphics(25,25);e.lineColor=0,e.lineWidth=2,e.beginFill(16354325),e.drawRoundedRect(0,0,280,500,15),Phaser.Sprite.call(this,a,0,Septikon.boardCenterY,e.generateTexture());var f=a.add.graphics(25,25);f.lineColor=0,f.lineWidth=2,f.beginFill(9773863),f.drawRoundedRect(0,0,50,50,15);var g=a.add.button(-75,Septikon.boardCenterY,f.generateTexture(),Septikon.rollDice,this);g.anchor.set(.5),this.anchor={x:.5,y:.5},Septikon.groupHUDRight.add(this),Septikon.groupDice.add(g);var h={font:"bold 32px Arial",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"};this.text=a.add.text(e.width/4*-1,Septikon.boardCenterY-e.height/2+40,d.title,h,Septikon.groupHUDRight),this.text.setShadow(3,3,"rgba(0,0,0,0.5)",4),this.text.anchor.set(.5),this.rollText=a.add.text(g.x,g.y,"Roll",h,Septikon.groupDice),this.rollText.setShadow(3,3,"rgba(0,0,0,0.5)",4),this.rollText.anchor.set(.5),e.destroy(),f.destroy()},Septikon.HUD.prototype=Object.create(Phaser.Sprite.prototype),Septikon.HUD.prototype.constructor=Septikon.HUD,Septikon.popup=function(a,b,c){var d=c.buttons.length,e=a.add.graphics(Septikon.boardCenterX,Septikon.boardCenterY);e.lineColor=0,e.lineWidth=2,e.beginFill(12010825),e.drawRoundedRect(Septikon.boardCenterX,Septikon.boardCenterY,400,200,8),Phaser.Sprite.call(this,a,Septikon.boardCenterX,Septikon.boardCenterY,e.generateTexture()),this.anchor.set(.5),this.x=Septikon.boardCenterX,this.y=Septikon.boardCenterY,Septikon.groupPopups.add(this);var f={font:"bold 24px Impact",fill:"#FBAE37",boundsAlignH:"center",boundsAlignV:"middle"};this.title=a.add.text(Septikon.boardCenterX,Septikon.boardCenterY-e.height/2+20,c.title,f,Septikon.groupPopups),this.title.setShadow(3,3,"rgba(0,0,0,0.5)",4),this.title.anchor.set(.5);var g={font:"16px Impact",fill:"#000",boundsAlignH:"center",boundsAlignV:"top",align:"center",wordWrap:!0,wordWrapWidth:300},h=a.add.text(Septikon.boardCenterX,Septikon.boardCenterY,c.content,g,Septikon.groupPopups);h.align="center",h.anchor.set(.5);for(index in c.buttons){var i=new Septikon.button(a,c.buttons[index].title,{x:this.x-40*(d-1)+80*index,y:this.y+this.height/2-30});if("undefine"==typeof c.buttons[index].context)var j=this;else var j=c.buttons[index].context;i.onInputUp.add(c.buttons[index].callback,j)}e.destroy()},Septikon.popup.prototype=Object.create(Phaser.Sprite.prototype),Septikon.popup.prototype.constructor=Septikon.popup,Septikon.button=function(a,b,c,d,e){var f=a.add.graphics(0,0);f.lineColor=0,f.lineWidth=2,f.beginFill(16494135),f.drawRoundedRect(0,0,75,25,4),Phaser.Button.call(this,a,c.x,c.y,f.generateTexture()),this.anchor.set(.5),Septikon.groupPopups.add(this);var g={font:"16px Impact",fill:"#000",boundsAlignH:"center",boundsAlignV:"middle"};this.title=a.add.text(c.x,c.y+2,b,g,Septikon.groupPopups),this.title.anchor.set(.5),f.destroy()},Septikon.button.prototype=Object.create(Phaser.Button.prototype),Septikon.button.prototype.constructor=Septikon.button;